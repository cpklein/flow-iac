participant SAP BRSAPP1
participant Integra
note over Integra#lightgray:--**flow Parameters [flow]\nflow parameters definition**\n** zsdsf""[PM001] :** [array]""\n    zsdsf\n** itens""[PM002] :** [array]""\n    itens\n
note over Integra#lightgray:--**integration Parameters [integration]\nintegration parameters definition**\n** Token""[PM003] :** [string]""\n    Token\n** Token PRD""[PM004] :** [string]""\n    Token\n
Client->Integra: --**API_GATEWAY_TRIGGER [TR001]\nAPI_GATEWAY_TRIGGER_DESC**\n**apiGatewayId :** ""AjWizswe""\n**apiGatewayVersionId :** ""E6yUSXeQ""\n**apiGatewayPathId :** ""rhtxwHT0""
activate Integra
rbox over Integra: --**Data Transformation [TL002]\nMódulo para fazer transformação de dados**\n**jsonata :** ""[jsonata expression bellow]""\n**data :** ""{}TR001 : body{/}""
expandable+ #lightgray --JSONATA Expression **[click to expand]
rbox over Integra: --**jsonata :** ""{\n    "TESTRUN": result.simulacao = true ? "X" : "",\n    "SALES_HEADER_IN": {\n                        "SALES_ORG": $substringBefore(result.orgVendas, "-"),\n                        "DLVSCHDUSE": $substringBefore(result.utilizacao, " -"),\n                        "DISTR_CHAN":  $substringBefore(result.canalDistribuicao, "-"),\n                        "DIVISION":  $substringBefore(result.setorAtividade, "-"),\n                        "SALES_GRP": $substringBefore(result.codVendedor, "-"),\n                        "SALES_OFF": $substringBefore(result.escritorioVendas, "-"),\n                        "PMNTTRMS": $substringBefore(result.codCondPagamento, "-"),\n                        "PURCH_NO_C": result.codSimulacao,\n                        "BILL_DATE": result.dataFaturamento != null ? $toMillis(result.dataFaturamento) ~> $fromMillis("[Y0001].[M01].[D01]") : null,\n                        "PO_DAT_S": result.dataEntrega != null ? $toMillis(result.dataEntrega) ~> $fromMillis("[Y0001].[M01].[D01]") : null,\n                        "INCOTERMS1": $substringBefore(result.incoterms, "-"),\n                        "S_PROC_IND": result.tipoCarga = "Fracionado" ? "FRAC" : "LOT",\n                        "SHIP_TYPE": result.tipoExpedicao,\n                        "PURCH_NO_S": result.numPedidoCliente,\n                        "PRICE_GRP": result.mostruario = true ? "99": ""\n                       },\n    "SALES_PARTNERS": [{\n                        "PARTN_NUMB": result.codCliente,\n                        "PARTN_ROLE": "AG"\n                      },\n                      {\n                        "PARTN_NUMB": result.codClienteCobranca,\n                        "PARTN_ROLE": "RG"\n                      },\n                      {\n                        "PARTN_NUMB": result.codClienteEntrega,\n                        "PARTN_ROLE": "WE"\n                      },\n                      {\n                        "PARTN_NUMB": result.transportadora != null ? $join([$substring("0000000000",$length(result.transportadora)), result.transportadora]) : "",\n                        "PARTN_ROLE": "SP"\n                      }],\n    "SALES_ITEMS_IN": [$map(result.produtos, function($v){\n                        {\n                            "ITM_NUMBER": $string($v.item),\n                            "MATERIAL": $v.codProdutoSap,\n                            "PLANT": $substringBefore($$.result.centro, "-"),\n                            "SHIP_POINT":  $substringBefore(result.localExp, "-"),\n                            "STORE_LOC":  $substringBefore(result.deposito, "-"),\n                            "TARGET_QTY": $string($v.qtde),\n                            "PRICE_GRP": $$.result.mostruario = true ? "99": ""\n                        }\n                    })],\n    "SALES_CONDITIONS_IN": $append($map(result.produtos, function($v){\n                                {\n                                    "ITM_NUMBER": $string($v.item),\n                                    "COND_TYPE": "ZNEG",\n                                    "COND_VALUE": $string($v.valorProposto),\n                                    "CURRENCY": "BRL"\n                                }\n                           }),$map(result.produtos, function($v){\n                                {\n                                    "ITM_NUMBER": $string($v.item),\n                                    "COND_TYPE": "ZDSR",\n                                    "COND_VALUE": $string($v.mostruarioPercent*10),\n                                    "CURRENCY": "BRL"\n                                }\n                           })),\n    "SALES_TEXT": $append($append([$map(result.produtos, function($v){\n                $exists($$.result.justificativa) = true ? {\n                    "DOC_NUMBER": " ",\n                    "ITM_NUMBER": $string($v.item),\n                    "TEXT_ID": "Z001",\n                    "LANGU": "P",\n                    "LANGU_ISO": " ",\n                    "FORMAT_COL": "*",\n                    "TEXT_LINE": $$.result.justificativa != null ? $replace($trim($$.result.justificativa), "–", "-") : $$.result.justificativa\n                }\n                })], \n                [\n                $exists($$.result.obsPedido) = true ? {\n                    "DOC_NUMBER": " ",\n                    "ITM_NUMBER": "000000",\n                    "TEXT_ID": "0003",\n                    "LANGU": "P",\n                    "LANGU_ISO": " ",\n                    "FORMAT_COL": "*",\n                    "TEXT_LINE": $$.result.obsPedido != null ? $trim($$.result.obsPedido) : $$.result.obsPedido\n                }\n                ]),\n                [\n                $exists($$.result.obsNf) = true ? {\n                    "DOC_NUMBER": " ",\n                    "ITM_NUMBER": "000000",\n                    "TEXT_ID": "NFH",\n                    "LANGU": "P",\n                    "LANGU_ISO": " ",\n                    "FORMAT_COL": "*",\n                    "TEXT_LINE": $$.result.obsNf != null ? $trim($$.result.obsNf) : $$.result.obsNf\n                }\n                ]\n                )\n}""
end
Integra->SAP BRSAPP1:--**SAP BRSAPP1 [CN001]\nModulo SAP brsapqa**\n**body :** ""{}TL002 : data{/}""
activate SAP BRSAPP1
SAP BRSAPP1->Integra:--**RESPONSE**
deactivate SAP BRSAPP1
alt IF
note over Integra#lightgray:--**IF [TL003]\nMódulo IF**\n**condition :** ""==""\n**variable1value : SMOP**\n    **operation :** ""$contains($string($map(param1.RETURN.NUMBER, function($v){$number($v) = 233 ? true : $number($v) = 311 ? true : false})), "false")""\n    **param1 :** ""{}CN001 : body{/}""\n**variable2value :** ""false""
else TRUE
group FOR
note over Integra#lightgray:--**For [TL006]\nExecuta um loop com base em uma lista**\n**loopCounter :** ""{}TL006 : loopCounter{/}""\n**forEndId :** ""TL008""\n**restartLoopCounter :** ""{}TL008 : restartLoopCounter{/}""\n**array : SMOP**\n    **operation :** ""param1.ITEMS_EX""\n    **param1 :** ""{}CN001 : body{/}""
rbox over Integra: --**Update Params [TL010]\nRealiza a atualizaçao de parametros do fluxo**\n**mCBkPP2s_value :** ""[{"SD_DOC":"","CONDIT_NO":"","ITM_NUMBER":"000001","COND_ST_NO":"008","COND_TYPE":"ZPCO","CONBASEVAL":"5.000000000","COND_VALUE":"2599.000000000","CONDVALUE":"12995.000000000","CONDISACTI":""},{"SD_DOC":"","CONDIT_NO":"","ITM_NUMBER":"000001","COND_ST_NO":"120","COND_TYPE":"ZJUR","CONBASEVAL":"5633.190000000","COND_VALUE":"3.836000000","CONDVALUE":"216.090000000","CONDISACTI":""},{"SD_DOC":"","CONDIT_NO":"","ITM_NUMBER":"000001","COND_ST_NO":"170","COND_TYPE":"ZNEG","CONBASEVAL":"5.000000000","COND_VALUE":"0.000000000","CONDVALUE":"0.000000000","CONDISACTI":"X"},{"SD_DOC":"","CONDIT_NO":"","ITM_NUMBER":"000001","COND_ST_NO":"170","COND_TYPE":"ZNEG","CONBASEVAL":"5.000000000","COND_VALUE":"1458.000000000","CONDVALUE":"7290.000000000","CONDISACTI":""},{"SD_DOC":"","CONDIT_NO":"","ITM_NUMBER":"000001","COND_ST_NO":"581","COND_TYPE":"ZTL4","CONBASEVAL":"12995.000000000","COND_VALUE":"18.000000000","CONDVALUE":"2339.100000000","CONDISACTI":""},{"SD_DOC":"","CONDIT_NO":"","ITM_NUMBER":"000001","COND_ST_NO":"585","COND_TYPE":"ZMC1","CONBASEVAL":"24387.520000000","COND_VALUE":"38.500000000","CONDVALUE":"4102.520000000","CONDISACTI":""},{"SD_DOC":"","CONDIT_NO":"","ITM_NUMBER":"000001","COND_ST_NO":"587","COND_TYPE":"ZIP8","CONBASEVAL":"6553.380000000","COND_VALUE":"6.500000000","CONDVALUE":"-428.730000000","CONDISACTI":""},{"SD_DOC":"","CONDIT_NO":"","ITM_NUMBER":"000001","COND_ST_NO":"588","COND_TYPE":"ZIP9","CONBASEVAL":"34614.690000000","COND_VALUE":"12.000000000","CONDVALUE":"839.100000000","CONDISACTI":""},{"SD_DOC":"","CONDIT_NO":"","ITM_NUMBER":"000001","COND_ST_NO":"610","COND_TYPE":"IPI3","CONBASEVAL":"7290.000000000","COND_VALUE":"6.500000000","CONDVALUE":"473.850000000","CONDISACTI":""},{"SD_DOC":"","CONDIT_NO":"","ITM_NUMBER":"000001","COND_ST_NO":"620","COND_TYPE":"ICM3","CONBASEVAL":"7290.000000000","COND_VALUE":"12.000000000","CONDVALUE":"874.800000000","CONDISACTI":""},{"SD_DOC":"","CONDIT_NO":"","ITM_NUMBER":"000001","COND_ST_NO":"622","COND_TYPE":"ICAP","CONBASEVAL":"0.000000000","COND_VALUE":"0.000000000","CONDVALUE":"0.000000000","CONDISACTI":""},{"SD_DOC":"","CONDIT_NO":"","ITM_NUMBER":"000001","COND_ST_NO":"630","COND_TYPE":"ICS3","CONBASEVAL":"9999999.990000000","COND_VALUE":"0.000000000","CONDVALUE":"0.000000000","CONDISACTI":""},{"SD_DOC":"","CONDIT_NO":"","ITM_NUMBER":"000001","COND_ST_NO":"755","COND_TYPE":"ZINF","CONBASEVAL":"7763.850000000","COND_VALUE":"100.000000000","CONDVALUE":"7763.850000000","CONDISACTI":""},{"SD_DOC":"","CONDIT_NO":"","ITM_NUMBER":"000001","COND_ST_NO":"861","COND_TYPE":"ZCM3","CONBASEVAL":"7290.000000000","COND_VALUE":"10.000000000","CONDVALUE":"729.000000000","CONDISACTI":""},{"SD_DOC":"","CONDIT_NO":"","ITM_NUMBER":"000001","COND_ST_NO":"925","COND_TYPE":"ZDSR","CONBASEVAL":"18496.550000000","COND_VALUE":"0.000000000","CONDVALUE":"0.000000000","CONDISACTI":"M"},{"SD_DOC":"","CONDIT_NO":"","ITM_NUMBER":"000001","COND_ST_NO":"925","COND_TYPE":"ZDSR","CONBASEVAL":"18496.550000000","COND_VALUE":"0.017000000","CONDVALUE":"3.140000000","CONDISACTI":""},{"SD_DOC":"","CONDIT_NO":"","ITM_NUMBER":"000001","COND_ST_NO":"946","COND_TYPE":"ZLSE","CONBASEVAL":"5.000000000","COND_VALUE":"0.000000000","CONDVALUE":"5606.500000000","CONDISACTI":""},{"SD_DOC":"","CONDIT_NO":"","ITM_NUMBER":"000001","COND_ST_NO":"991","COND_TYPE":"IPS3","CONBASEVAL":"6415.200000000","COND_VALUE":"1.650000000","CONDVALUE":"105.850000000","CONDISACTI":""},{"SD_DOC":"","CONDIT_NO":"","ITM_NUMBER":"000001","COND_ST_NO":"993","COND_TYPE":"ICN3","CONBASEVAL":"6415.200000000","COND_VALUE":"7.600000000","CONDVALUE":"487.560000000","CONDISACTI":""},{"SD_DOC":"","CONDIT_NO":"","ITM_NUMBER":"000001","COND_ST_NO":"995","COND_TYPE":"ZFRS","CONBASEVAL":"46923.890000000","COND_VALUE":"5.750000000","CONDVALUE":"5.750000000","CONDISACTI":""}]""\n**mCBkPP2s_smop : SMOP**\n    **operation :** ""$append(param3, param1.ZSDSF_CONDITIONS[ITM_NUMBER = $$.param2.ITM_NUMBER])""\n    **param1 :** ""{}CN001 : body{/}""\n    **param2 :** ""{}TL006 : element{/}""\n    **param3 :** ""[]PM001 : zsdsf[/]""\n    **param3 :** ""[]PM001 : zsdsf[/]""\n**mCBkPP2s_key :** ""zsdsf""\n**mCBkPP2s_type :** ""array""\n**mCBkPP2s_example :** """"\n**mCBkPP2s_example :** """"
rbox over Integra: --**Data Transformation [TL005]\nMódulo para fazer transformação de dados**\n**jsonata :** ""[jsonata expression bellow]""\n**data :** ""{"item": {}TL006 : element{/},\n    "ZSDSF": []mCBkPP2s : zsdsf[/],\n    "setor": "{}54TNLoke : body.setorAtividade{/}"\n}""
expandable+ #lightgray --JSONATA Expression **[click to expand]
rbox over Integra: --**jsonata :** ""{\n                "item": result.item.ITM_NUMBER,\n                "codProdutoSap": result.item.MATERIAL,\n                "juros": result.ZSDSF[COND_TYPE = 'ZJUR'].CONDVALUE,\n                "jurosPorcen": result.ZSDSF[COND_TYPE = 'ZJUR'].COND_VALUE,\n                "psvCaixa": result.ZSDSF[COND_TYPE = 'ZNEG'][CONDISACTI = ""].CONDVALUE,\n                "valorLiquidoSemEncargos": $substringBefore(result.setor, "-") = "03" ? result.item.NET_VALUE : result.ZSDSF[COND_TYPE = 'ZLSE'].CONDVALUE,\n                "valorTotalNF": result.ZSDSF[COND_TYPE = 'ZINF'].CONDVALUE,\n                "psv": result.ZSDSF[COND_TYPE = 'ZPCO'].CONDVALUE,\n                "margemPercent": result.ZSDSF[COND_TYPE = 'ZMC1'].COND_VALUE,\n                "margem": result.ZSDSF[COND_TYPE = 'ZMC1'].CONDVALUE,\n                "icmsDestinoPorcen": $exists(result.ZSDSF[COND_TYPE = 'ICAP'].COND_VALUE) = true ? result.ZSDSF[COND_TYPE = 'ICAP'].COND_VALUE : "0",\n                "icmsDestinoValor": $exists(result.ZSDSF[COND_TYPE = 'ICAP'].CONDVALUE) = true ? result.ZSDSF[COND_TYPE = 'ICAP'].CONDVALUE : "0",\n                "icmsValor": result.ZSDSF[COND_TYPE = 'ICM3'].CONDVALUE,\n                "icmsPorcen": result.ZSDSF[COND_TYPE = 'ZIP9'].COND_VALUE,\n                "pisPorcen": result.ZSDSF[COND_TYPE = 'IPS3'].COND_VALUE,\n                "pisValor": result.ZSDSF[COND_TYPE = 'IPS3'].CONDVALUE,\n                "cofinsPorcen": result.ZSDSF[COND_TYPE = 'ICN3'].COND_VALUE,\n                "cofinsValor": result.ZSDSF[COND_TYPE = 'ICN3'].CONDVALUE,\n                "ipiPorcen": $exists(result.ZSDSF[COND_TYPE = 'ZIP8'].COND_VALUE) = true ? result.ZSDSF[COND_TYPE = 'ZIP8'].COND_VALUE : "0",\n                "ipiValor": $exists(result.ZSDSF[COND_TYPE = 'IPI3'].CONDVALUE) = true ? result.ZSDSF[COND_TYPE = 'IPI3'].CONDVALUE : "0",\n                "incentivoICMSPorcen": $exists(result.ZSDSF[COND_TYPE = 'ZCM3'].COND_VALUE) = true ? result.ZSDSF[COND_TYPE = 'ZCM3'].COND_VALUE : "0",\n                "incentivoICMSValor": $exists(result.ZSDSF[COND_TYPE = 'ZCM3'].CONDVALUE) = true ? result.ZSDSF[COND_TYPE = 'ZCM3'].CONDVALUE : "0",\n                "pesoLiquido": result.item.NET_WEIGHT,\n                "pesoBruto": result.item.GROSS_WEIG,\n                "volume_Metragem": result.item.VOLUME,\n                "valorMostruario": $exists(result.ZSDSF[COND_TYPE = 'ZDSR'][CONDISACTI = ""].CONDVALUE) = true ? result.ZSDSF[COND_TYPE = 'ZDSR'][CONDISACTI = ""].CONDVALUE : "0",\n                "armazenagemST": $exists(result.ZSDSF[COND_TYPE = 'ZARM'].COND_VALUE) = true ? result.ZSDSF[COND_TYPE = 'ZARM'].COND_VALUE : "0" ,\n                "valorComFreteCIF": "0",\n                "frete": $exists(result.ZSDSF[COND_TYPE = 'ZFRS'].COND_VALUE) = true ? result.ZSDSF[COND_TYPE = 'ZFRS'].COND_VALUE : "0",\n                "valorConhecimentoFreteUnit": "0",\n                "substituicaoTributaria": $exists(result.ZSDSF[COND_TYPE = 'ICS3'].CONDVALUE) = true ? result.ZSDSF[COND_TYPE = 'ICS3'].CONDVALUE : "0",\n                "substituicaoTributariaPorcen": $exists(result.ZSDSF[COND_TYPE = 'ICS3'].COND_VALUE) = true ? result.ZSDSF[COND_TYPE = 'ICS3'].COND_VALUE : "0",\n                "costOfSales": $exists(result.ZSDSF[COND_TYPE = "ZCMU"].CONDVALUE) = true ? result.ZSDSF[COND_TYPE = "ZCMU"].CONDVALUE : "0",\n                "icmsPsv": $exists(result.ZSDSF[COND_TYPE = 'ZTL4'].COND_VALUE) = true ? result.ZSDSF[COND_TYPE = 'ZTL4'].COND_VALUE : "0",\n                "precoAVista": $exists(result.ZSDSF[COND_TYPE = "ZNEP"].COND_VALUE) = true ? result.ZSDSF[COND_TYPE = "ZNEP"].COND_VALUE : "0",\n                "icmsDisplay": result.ZSDSF[COND_TYPE = 'ICM3'].COND_VALUE,\n                "ipiDisplay": $exists(result.ZSDSF[COND_TYPE = 'IPI3'].COND_VALUE) = true ? result.ZSDSF[COND_TYPE = 'IPI3'].COND_VALUE : "0"\n}""
end
rbox over Integra: --**Update Params [TL007]\nRealiza a atualizaçao de parametros do fluxo**\n**QQCVSxi2_value :** ""[{"item":"000001","codProdutoSap":"6LF22XAB/1B24","juros":"1.020000000","jurosPorcen":"3.836000000","psvCaixa":"202.530000000","valorLiquidoSemEncargos":"150.710000000","valorTotalNF":"222.280000000","psv":"129.120000000","margemPercent":"0.000000000","margem":"0.000000000","icmsDestinoPorcen":"0.000000000","icmsDestinoValor":"0.000000000","icmsValor":"36.460000000","icmsPorcen":"18.000000000","pisPorcen":"1.650000000","pisValor":"2.740000000","cofinsPorcen":"7.600000000","cofinsValor":"12.620000000","ipiPorcen":"9.750000000","ipiValor":"19.750000000","pesoLiquido":"1.030","pesoBruto":"1.210","volume_Metragem":"0.000","armazenagemST":"0","valorComFreteCIF":0,"frete":"0.000000000","valorConhecimentoFreteUnit":"0","substituicaoTributaria":"0.000000000","substituicaoTributariaPorcen":"0.000000000","costOfSales":"0","icmsPsv":"18.000000000","precoAVista":"202.530000000"}]""\n**QQCVSxi2_smop : SMOP**\n    **operation :** ""$append(param2, param1)""\n    **param1 :** ""{}TL005 : data{/}""\n    **param2 :** ""[]PM002 : itens[/]""\n    **param2 :** ""[]PM002 : itens[/]""\n**QQCVSxi2_key :** ""itens""\n**QQCVSxi2_type :** ""array""\n**QQCVSxi2_example :** """"\n**QQCVSxi2_example :** """"\n**mCBkPP2s_value :** ""[]""\n**mCBkPP2s_value :** ""[]""\n**mCBkPP2s_key :** ""zsdsf""\n**mCBkPP2s_type :** ""array""\n**mCBkPP2s_example :** """"\n**mCBkPP2s_example :** """"
end
rbox over Integra: --**Data Transformation [TL009]\nMódulo para fazer transformação de dados**\n**jsonata :** ""[jsonata expression bellow]""\n**data :** ""{\n    "SALES_DOC": "{}CN001 : body.SALESDOCUMENT_EX{/}",\n    "SALES_HEADER": {}CN001 : body.SALES_HEADER_OUT{/},\n    "ITEMS": []QQCVSxi2 : itens[/]\n}\n\n""
expandable+ #lightgray --JSONATA Expression **[click to expand]
rbox over Integra: --**jsonata :** ""{\n    "numeroPedido": result.SALES_HEADER.PURCH_NO,\n    "mensagens": "",\n    "numContrato": result.SALES_DOC,\n    "itens": result.ITEMS\n}""
end
rbox over Integra: --**Update Params [TL011]\nRealiza a atualizaçao de parametros do fluxo**\n**QQCVSxi2_value :** ""[]""\n**QQCVSxi2_value :** ""[]""\n**QQCVSxi2_key :** ""itens""\n**QQCVSxi2_type :** ""array""\n**QQCVSxi2_example :** """"\n**QQCVSxi2_example :** """"
rbox over Integra: --**Return [TL001]\nRetorna os dados de uma requisição**\n**data :** ""{}TL009 : data{/}""\n**jsonata :** ""[jsonata expression bellow]""
expandable+ #lightgray --JSONATA Expression **[click to expand]
rbox over Integra: --**jsonata :** ""result""
end
Integra->Client: --**RESPONSE
else FALSE
rbox over Integra: --**Return [TL004]\nRetorna os dados de uma requisição**\n**data :** ""{}CN001 : body{/}""\n**jsonata :** ""[jsonata expression bellow]""
expandable+ #lightgray --JSONATA Expression **[click to expand]
rbox over Integra: --**jsonata :** ""{\n"mensagens": $append(result.RETURN[NUMBER != "233"].MESSAGE, $count(result.RETURN[NUMBER = "999"][$contains(MESSAGE, "Justificativa de preço")]) > 0 ? "Valor negociado fora da margem de negociação") \n}""
end
Integra->Client: --**RESPONSE
